<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Termux File Manager</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&family=Noto+Sans+KR:wght@400;500;700&display=swap');
* { margin: 0; padding: 0; box-sizing: border-box; }
:root {
    --bg-deep: #0a0e17; --bg-panel: #111827; --bg-card: #1a2236;
    --bg-hover: #243049; --accent: #22d3ee; --accent-dim: #0e7490;
    --accent-glow: rgba(34,211,238,0.15); --green: #34d399; --red: #f87171;
    --orange: #fbbf24; --text: #e2e8f0; --text-dim: #94a3b8;
    --border: #1e293b; --radius: 10px;
}
html, body { height: 100%; font-family: 'Noto Sans KR', sans-serif; background: var(--bg-deep); color: var(--text); overflow: hidden; }
.app { display: flex; flex-direction: column; height: 100vh; }
.header { background: var(--bg-panel); border-bottom: 1px solid var(--border); padding: 10px 20px; display: flex; align-items: center; gap: 10px; flex-shrink: 0; }
.header .logo { font-family: 'JetBrains Mono', monospace; font-weight: 700; font-size: 18px; color: var(--accent); }
.header .logo span { color: var(--text-dim); font-weight: 400; font-size: 13px; }
.toolbar { background: var(--bg-panel); border-bottom: 1px solid var(--border); padding: 6px 20px; display: flex; align-items: center; gap: 6px; flex-shrink: 0; flex-wrap: wrap; }
.toolbar-hidden { display: none !important; }
.breadcrumb { font-family: 'JetBrains Mono', monospace; font-size: 13px; color: var(--text-dim); flex: 1; min-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.breadcrumb span { cursor: pointer; color: var(--accent); transition: 0.2s; }
.breadcrumb span:hover { text-decoration: underline; }
.breadcrumb .sep { color: var(--text-dim); cursor: default; margin: 0 2px; }
.btn { font-family: 'Noto Sans KR', sans-serif; font-size: 12px; font-weight: 500; padding: 5px 12px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg-card); color: var(--text); cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; gap: 4px; white-space: nowrap; }
.btn:hover { background: var(--bg-hover); border-color: var(--accent-dim); }
.btn.primary { background: var(--accent-dim); border-color: var(--accent); color: #fff; }
.btn.primary:hover { background: var(--accent); }
.btn.danger { border-color: #7f1d1d; color: var(--red); }
.btn.danger:hover { background: #7f1d1d33; }
.btn.small { padding: 3px 8px; font-size: 11px; }
.sub-toolbar { background: var(--bg-deep); border-bottom: 1px solid var(--border); padding: 6px 20px; display: flex; align-items: center; gap: 8px; flex-shrink: 0; }
.sub-toolbar.hidden { display: none !important; }
.search-input { font-family: 'JetBrains Mono', monospace; font-size: 12px; padding: 5px 10px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg-card); color: var(--text); flex: 1; max-width: 300px; outline: none; }
.search-input:focus { border-color: var(--accent); }
.search-input::placeholder { color: var(--text-dim); }
.sort-select { font-size: 11px; padding: 4px 8px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg-card); color: var(--text); cursor: pointer; outline: none; }
.toggle-label { font-size: 11px; color: var(--text-dim); display: flex; align-items: center; gap: 4px; cursor: pointer; }
.toggle-label input { accent-color: var(--accent); }
.selection-bar { background: var(--accent-dim); padding: 6px 20px; display: flex; align-items: center; gap: 10px; flex-shrink: 0; font-size: 13px; color: #fff; }
.selection-bar.hidden { display: none !important; }
.fav-bar { background: var(--bg-panel); border-bottom: 1px solid var(--border); padding: 4px 20px; display: flex; align-items: center; gap: 4px; flex-shrink: 0; overflow-x: auto; }
.fav-bar.hidden { display: none !important; }
.fav-chip { font-size: 11px; padding: 3px 10px; border: 1px solid var(--border); border-radius: 12px; background: var(--bg-card); color: var(--accent); cursor: pointer; white-space: nowrap; display: flex; align-items: center; gap: 4px; }
.fav-chip:hover { background: var(--bg-hover); }
.fav-chip .fav-remove { color: var(--text-dim); font-size: 10px; cursor: pointer; }
.fav-chip .fav-remove:hover { color: var(--red); }
.file-area { flex: 1; overflow-y: auto; padding: 8px 20px; }
.file-area-hidden { display: none !important; }
.file-list { display: flex; flex-direction: column; }
.file-item { display: flex; align-items: center; gap: 10px; padding: 8px 10px; border-radius: var(--radius); cursor: pointer; transition: background 0.15s; border: 1px solid transparent; }
.file-item:hover { background: var(--bg-card); }
.file-item.selected { background: var(--accent-glow); border-color: var(--accent-dim); }
.file-item .check-box { width: 16px; height: 16px; border: 1.5px solid var(--border); border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 10px; flex-shrink: 0; }
.file-item.selected .check-box { background: var(--accent); border-color: var(--accent); color: #000; }
.file-icon { font-size: 18px; width: 28px; text-align: center; flex-shrink: 0; }
.file-info { flex: 1; min-width: 0; }
.file-name { font-size: 13px; font-weight: 500; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.file-meta { font-size: 11px; color: var(--text-dim); }
.modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 1000; display: none; align-items: center; justify-content: center; padding: 20px; }
.modal-overlay.active { display: flex; }
.modal { background: var(--bg-panel); border: 1px solid var(--border); border-radius: 14px; padding: 24px; max-width: 700px; width: 100%; max-height: 85vh; overflow-y: auto; }
.modal h3 { margin-bottom: 16px; font-size: 16px; }
.modal input[type="text"], .modal textarea { width: 100%; font-family: 'JetBrains Mono', monospace; font-size: 13px; padding: 8px 12px; border: 1px solid var(--border); border-radius: 8px; background: var(--bg-card); color: var(--text); margin-bottom: 12px; outline: none; resize: vertical; }
.modal input:focus, .modal textarea:focus { border-color: var(--accent); }
.modal-actions { display: flex; gap: 8px; margin-top: 16px; justify-content: flex-end; }
.upload-zone { border: 2px dashed var(--border); border-radius: var(--radius); padding: 30px; text-align: center; margin-bottom: 12px; transition: 0.3s; color: var(--text-dim); }
.upload-zone.dragover { border-color: var(--accent); background: var(--accent-glow); }
.upload-zone .big-icon { font-size: 36px; margin-bottom: 8px; }
.editor-textarea { width: 100%; min-height: 400px; font-family: 'JetBrains Mono', monospace; font-size: 13px; line-height: 1.6; padding: 12px; border: 1px solid var(--border); border-radius: 8px; background: #0d1117; color: #e6edf3; resize: vertical; tab-size: 4; outline: none; }
.editor-textarea:focus { border-color: var(--accent); }
.editor-info { font-size: 11px; color: var(--text-dim); margin-bottom: 8px; }
.image-preview-container { display: flex; justify-content: center; align-items: center; background: #000; border-radius: 8px; padding: 16px; margin-bottom: 12px; max-height: 60vh; overflow: hidden; }
.image-preview-container img { max-width: 100%; max-height: 55vh; object-fit: contain; border-radius: 4px; }
.toast-container { position: fixed; bottom: 16px; right: 16px; z-index: 2000; display: flex; flex-direction: column; gap: 6px; }
.toast { background: var(--bg-card); border: 1px solid var(--accent); border-radius: 8px; padding: 10px 16px; font-size: 13px; animation: toastIn 0.3s ease; max-width: 350px; }
.toast.error { border-color: var(--red); }
@keyframes toastIn { from { opacity: 0; transform: translateX(30px); } to { opacity: 1; transform: translateX(0); } }
.context-menu { position: fixed; background: var(--bg-panel); border: 1px solid var(--border); border-radius: 10px; padding: 6px 0; min-width: 180px; z-index: 1500; box-shadow: 0 8px 24px rgba(0,0,0,0.5); display: none; }
.context-menu.active { display: block; }
.context-menu-item { padding: 8px 16px; font-size: 13px; cursor: pointer; transition: 0.15s; }
.context-menu-item:hover { background: var(--bg-hover); }
.context-menu-item.danger { color: var(--red); }
.context-menu-sep { border-top: 1px solid var(--border); margin: 4px 0; }
.loading { display: flex; align-items: center; justify-content: center; gap: 10px; padding: 40px; color: var(--text-dim); }
.spinner { width: 20px; height: 20px; border: 2px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.6s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }
.preview-content { background: #0d1117; border: 1px solid var(--border); border-radius: 8px; padding: 12px; font-family: 'JetBrains Mono', monospace; font-size: 12px; line-height: 1.6; white-space: pre-wrap; word-wrap: break-word; max-height: 50vh; overflow-y: auto; color: #c9d1d9; }
.progress-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 1500; display: flex; align-items: center; justify-content: center; }
.progress-box { background: var(--bg-panel); border: 1px solid var(--border); border-radius: 14px; padding: 30px; min-width: 350px; max-width: 500px; text-align: center; }
.progress-bar-track { height: 8px; background: var(--bg-card); border-radius: 4px; margin: 16px 0 8px; overflow: hidden; }
.progress-bar-fill { height: 100%; background: linear-gradient(90deg, var(--accent-dim), var(--accent)); border-radius: 4px; transition: width 0.3s; width: 0%; }
.terminal-view { display: none; flex-direction: column; flex: 1; overflow: hidden; background: #0d1117; }
.terminal-view.active { display: flex; }
.term-toolbar { display: flex; align-items: center; gap: 6px; padding: 6px 12px; background: #161b22; border-bottom: 1px solid #21262d; flex-shrink: 0; }
.term-tabs { display: flex; gap: 2px; flex: 1; overflow-x: auto; }
.term-tab { font-family: 'JetBrains Mono', monospace; font-size: 11px; padding: 4px 10px; background: #0d1117; border: 1px solid #21262d; border-radius: 6px 6px 0 0; color: #8b949e; cursor: pointer; white-space: nowrap; display: flex; align-items: center; gap: 4px; }
.term-tab.active { background: #161b22; color: #e6edf3; border-bottom-color: transparent; }
.tab-close { font-size: 12px; opacity: 0.5; cursor: pointer; }
.tab-close:hover { opacity: 1; color: var(--red); }
.term-tab-add { font-size: 14px; padding: 2px 8px; cursor: pointer; color: #8b949e; border-radius: 4px; }
.term-tab-add:hover { color: var(--accent); background: #21262d; }
.term-actions { display: flex; gap: 4px; }
.term-btn { font-size: 11px; padding: 3px 8px; border: 1px solid #30363d; background: #0d1117; color: #8b949e; border-radius: 4px; cursor: pointer; }
.term-btn:hover { color: #e6edf3; border-color: #484f58; }
.term-btn.ctrl-c:hover { color: var(--orange); border-color: var(--orange); }
.term-btn.kill:hover { color: var(--red); border-color: var(--red); }
.term-output { flex: 1; overflow-y: auto; padding: 12px; font-family: 'JetBrains Mono', monospace; font-size: 13px; line-height: 1.5; white-space: pre-wrap; word-break: break-all; color: #e6edf3; }
.term-quick-bar { display: flex; gap: 4px; padding: 6px 12px; background: #161b22; border-top: 1px solid #21262d; flex-shrink: 0; overflow-x: auto; }
.term-quick { font-size: 11px; padding: 3px 10px; border: 1px solid #30363d; background: #0d1117; color: #bc8cff; cursor: pointer; border-radius: 4px; white-space: nowrap; }
.term-quick:hover { background: #161b22; border-color: #bc8cff; }
.term-input-bar { display: flex; gap: 6px; padding: 8px 12px; background: #0d1117; border-top: 1px solid #21262d; flex-shrink: 0; }
.term-prompt { font-family: 'JetBrains Mono', monospace; color: var(--green); font-size: 13px; line-height: 30px; }
.term-input { flex: 1; font-family: 'JetBrains Mono', monospace; font-size: 13px; padding: 6px 10px; background: #161b22; border: 1px solid #30363d; border-radius: 6px; color: #e6edf3; outline: none; }
.term-input:focus { border-color: var(--accent); }
.term-send { font-size: 12px; padding: 6px 14px; background: var(--accent-dim); color: white; border: none; border-radius: 6px; cursor: pointer; }
.term-send:hover { background: var(--accent); }
.term-status-bar { display: flex; align-items: center; gap: 6px; padding: 4px 12px; background: #161b22; font-size: 11px; color: #8b949e; border-top: 1px solid #21262d; flex-shrink: 0; }
.term-dot { width: 8px; height: 8px; border-radius: 50%; background: #484f58; flex-shrink: 0; }
.term-dot.alive { background: var(--green); }
.search-results { border-top: 1px solid var(--border); padding: 6px 20px 4px; font-size: 12px; color: var(--accent); background: var(--bg-deep); }
@media (max-width: 600px) { .header { padding: 8px 12px; } .toolbar { padding: 5px 12px; } .file-area { padding: 6px 12px; } .btn { padding: 4px 8px; font-size: 11px; } .file-item .check-box { display: none; } }
</style>
</head>
<body>
<div class="app" id="app">
    <div class="header">
        <div class="logo">ğŸ“‚ TermuxFM <span>v2</span></div>
        <div style="flex:1"></div>
        <button class="btn" onclick="toggleTerminal()" id="termToggleBtn">ğŸ–¥ í„°ë¯¸ë„</button>
        <button class="btn" onclick="window.open(getLibraryUrl(), '_blank')">ğŸ“š ë„ì„œê´€</button>
        <button class="btn primary" onclick="backupST()">ğŸ’¾ ë°±ì—…</button>
        <button class="btn" onclick="showSettingsModal()">âš™ï¸</button>
    </div>
    <div class="fav-bar hidden" id="favBar"></div>
    <div class="toolbar" id="mainToolbar">
        <button class="btn" onclick="goUp()">â¬†</button>
        <button class="btn" onclick="goHome()">ğŸ </button>
        <button class="btn" onclick="goStorage()">ğŸ’¾ ì €ì¥ì†Œ</button>
        <button class="btn" onclick="goSDCard()">ğŸ“€ SD</button>
        <button class="btn" onclick="showUploadModal()">ğŸ“¤</button>
        <button class="btn" onclick="showMkdirModal()">ğŸ“+</button>
        <button class="btn" onclick="pasteHere()">ğŸ“‹</button>
        <button class="btn" onclick="addFavorite()">â­</button>
        <div class="breadcrumb" id="breadcrumb">~</div>
    </div>
    <div class="sub-toolbar" id="subToolbar">
        <input type="text" class="search-input" id="searchInput" placeholder="ğŸ” íŒŒì¼ ê²€ìƒ‰..." oninput="onSearchInput(this.value)">
        <select class="sort-select" id="sortSelect" onchange="onSortChange()">
            <option value="name-asc">ì´ë¦„â†‘</option><option value="name-desc">ì´ë¦„â†“</option>
            <option value="size-desc">í¬ê¸°â†“</option><option value="size-asc">í¬ê¸°â†‘</option>
            <option value="date-desc">ìµœì‹ ìˆœ</option><option value="date-asc">ì˜¤ë˜ëœìˆœ</option>
        </select>
        <label class="toggle-label"><input type="checkbox" id="showHidden" onchange="onToggleHidden()"> ìˆ¨ê¹€</label>
    </div>
    <div class="selection-bar hidden" id="selectionBar">
        <span id="selectionCount">0ê°œ ì„ íƒ</span>
        <button class="btn small danger" onclick="batchDelete()">ğŸ—‘ ì¼ê´„ ì‚­ì œ</button>
        <button class="btn small" onclick="clearSelection()">âœ• í•´ì œ</button>
    </div>
    <div class="search-results hidden" id="searchResultsBar"></div>
    <div class="file-area" id="fileArea"><div class="loading"><div class="spinner"></div> ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div></div>
    <div class="terminal-view" id="terminalView">
        <div class="term-toolbar"><div class="term-tabs" id="termTabs"></div><span class="term-tab-add" onclick="termNewTab()">ï¼‹</span><div class="term-actions"><button class="term-btn ctrl-c" onclick="termSignal('SIGINT')">âŒƒC</button><button class="term-btn kill" onclick="termKillCurrent()">âœ•</button><button class="term-btn" onclick="termClearScreen()">ğŸ—‘</button></div></div>
        <div class="term-output" id="termOutput"></div>
        <div class="term-quick-bar">
            <span class="term-quick" onclick="termQuick('cd ~/SillyTavern && ./start.sh')">â–¶ STì‹œì‘</span>
            <span class="term-quick" onclick="termSignal('SIGINT')">âŒƒC</span>
            <span class="term-quick" onclick="termQuick('cd ~/SillyTavern && git pull && npm install')">â¬‡ STì—…ëƒ</span>
            <span class="term-quick" onclick="termQuick('ls -la')">ls</span>
            <span class="term-quick" onclick="termQuick('ps aux | grep node')">í”„ë¡œì„¸ìŠ¤</span>
            <span class="term-quick" onclick="termQuick('free -h && df -h')">ì‹œìŠ¤í…œ</span>
        </div>
        <div class="term-input-bar"><span class="term-prompt">$</span><input type="text" class="term-input" id="termInput" placeholder="ëª…ë ¹ì–´ ì…ë ¥..." autocomplete="off" spellcheck="false"><button class="term-send" onclick="termSendInput()">ì „ì†¡</button></div>
        <div class="term-status-bar"><span class="term-dot" id="termDot"></span><span id="termStatusText">ì—°ê²° ì•ˆ ë¨</span></div>
    </div>
</div>
<div class="context-menu" id="contextMenu">
    <div class="context-menu-item" onclick="downloadSelected()">ğŸ“¥ ë‹¤ìš´ë¡œë“œ</div>
    <div class="context-menu-item" id="ctxDownloadZip" style="display:none" onclick="downloadFolderZip()">ğŸ“¦ í´ë” ì••ì¶•</div>
    <div class="context-menu-item" onclick="previewSelected()">ğŸ‘ ë¯¸ë¦¬ë³´ê¸°</div>
    <div class="context-menu-item" onclick="editSelected()">âœï¸ í¸ì§‘</div>
    <div class="context-menu-sep"></div>
    <div class="context-menu-item" onclick="copySelected()">ğŸ“‹ ë³µì‚¬</div>
    <div class="context-menu-item" onclick="renameSelected()">âœï¸ ì´ë¦„ë³€ê²½</div>
    <div class="context-menu-item" onclick="showFileInfo()">â„¹ï¸ ì •ë³´</div>
    <div class="context-menu-sep"></div>
    <div class="context-menu-item danger" onclick="deleteSelected()">ğŸ—‘ ì‚­ì œ</div>
</div>
<div class="modal-overlay" id="modalOverlay" onclick="closeModalOutside(event)"><div class="modal" id="modalContent"></div></div>
<div class="toast-container" id="toastContainer"></div>
<script>
const API_BASE = window.location.origin + '/api/plugins/termux-file-manager';
let currentPath = '', fileItems = [], allItems = [];
let selectedItems = new Set(), lastSelectedIdx = -1;
let currentSort = 'name-asc', showHiddenFiles = false, isSearchMode = false, searchTimeout = null;

async function api(ep, body={}) {
    const res = await fetch(API_BASE+ep, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body) });
    if (!res.ok) { const e = await res.json().catch(()=>({})); throw new Error(e.error||'Request failed'); }
    return res;
}
function toast(msg, type='success') { const el=document.createElement('div'); el.className=`toast ${type}`; el.textContent=msg; document.getElementById('toastContainer').appendChild(el); setTimeout(()=>el.remove(),3000); }
function escHtml(s) { return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
function formatSize(b) { if(!b)return'â€”'; if(b<1024)return b+' B'; if(b<1048576)return(b/1024).toFixed(1)+' KB'; if(b<1073741824)return(b/1048576).toFixed(1)+' MB'; return(b/1073741824).toFixed(2)+' GB'; }

// ===== FILE LISTING =====
async function loadDir(dirPath='') {
    currentPath=dirPath; isSearchMode=false;
    document.getElementById('searchInput').value='';
    document.getElementById('searchResultsBar').classList.add('hidden');
    clearSelection();
    const area=document.getElementById('fileArea');
    area.innerHTML='<div class="loading"><div class="spinner"></div> ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
    try {
        const res=await api('/list',{path:dirPath}); const data=await res.json();
        renderBreadcrumb(data.currentPath); allItems=data.items; applyFilterAndSort();
    } catch(err) { area.innerHTML=`<div class="loading" style="color:var(--red)">âŒ ${err.message}</div>`; }
}
function applyFilterAndSort() {
    let items=[...allItems];
    if(!showHiddenFiles) items=items.filter(i=>!i.name.startsWith('.'));
    const [sk,sd]=currentSort.split('-');
    items.sort((a,b)=>{
        if(a.isDirectory&&!b.isDirectory)return -1; if(!a.isDirectory&&b.isDirectory)return 1;
        let c=0; if(sk==='name')c=a.name.localeCompare(b.name); else if(sk==='size')c=a.size-b.size; else if(sk==='date')c=(a.mtime||'').localeCompare(b.mtime||'');
        return sd==='desc'?-c:c;
    });
    fileItems=items; renderFiles(items);
}
function onSortChange() { currentSort=document.getElementById('sortSelect').value; if(!isSearchMode) applyFilterAndSort(); }
function onToggleHidden() { showHiddenFiles=document.getElementById('showHidden').checked; if(!isSearchMode) applyFilterAndSort(); }

function renderBreadcrumb(pathStr) {
    const bc=document.getElementById('breadcrumb'); let html='';
    if(pathStr.startsWith('/storage')) {
        const parts=pathStr.split('/').filter(Boolean); let p='';
        for(const part of parts){p+='/'+part; html+=`<span class="sep">/</span><span onclick="loadDir('${p}')">${part}</span>`;}
        html=`<span onclick="goHome()">~</span>`+html;
    } else {
        const parts=pathStr.split('/').filter(Boolean); html=`<span onclick="goHome()">~</span>`; let p='';
        for(const part of parts){ if(part==='~')continue; p+=(p?'/':'')+part; html+=`<span class="sep">/</span><span onclick="loadDir('${p}')">${part}</span>`; }
    }
    bc.innerHTML=html;
}
function getFileIcon(item) {
    if(item.isDirectory) return {cls:'folder',icon:'ğŸ“'};
    const ext=item.name.split('.').pop().toLowerCase();
    if(['tar','gz','zip','7z','rar','bz2','xz'].includes(ext)) return {cls:'archive',icon:'ğŸ“¦'};
    if(['png','jpg','jpeg','gif','webp','svg','bmp','ico'].includes(ext)) return {cls:'image',icon:'ğŸ–¼'};
    if(['js','ts','py','json','yaml','yml','html','css','sh','md','jsx','vue','c','cpp','rs','go'].includes(ext)) return {cls:'code',icon:'ğŸ“'};
    if(['mp3','wav','ogg','flac','m4a'].includes(ext)) return {cls:'file',icon:'ğŸµ'};
    if(['mp4','mkv','avi','mov','webm'].includes(ext)) return {cls:'file',icon:'ğŸ¬'};
    return {cls:'file',icon:'ğŸ“„'};
}
function renderFiles(items) {
    const area=document.getElementById('fileArea');
    if(!items.length){ area.innerHTML='<div class="loading">ğŸ“­ ë¹ˆ í´ë”</div>'; return; }
    let html='<div class="file-list">';
    for(let i=0;i<items.length;i++){
        const item=items[i], ico=getFileIcon(item);
        const date=item.mtime?new Date(item.mtime).toLocaleString('ko-KR',{month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'}):'';
        const sel=selectedItems.has(i)?' selected':'';
        const meta=item.isDirectory?'í´ë”'+(item.childCount!=null?' Â· '+item.childCount+'ê°œ':''):formatSize(item.size);
        const pathInfo=(isSearchMode&&item.path)?`<span style="color:var(--accent);font-size:10px"> ${escHtml(item.path)}</span>`:'';
        html+=`<div class="file-item${sel}" data-index="${i}" onclick="selectItem(${i},event)" ondblclick="openItem(${i})" oncontextmenu="showContext(event,${i})"><div class="check-box">${sel?'âœ“':''}</div><div class="file-icon ${ico.cls}">${ico.icon}</div><div class="file-info"><div class="file-name">${escHtml(item.name)}${pathInfo}</div><div class="file-meta">${meta}${date?' Â· '+date:''}</div></div></div>`;
    }
    html+='</div>'; area.innerHTML=html;
}

// ===== SELECTION =====
function selectItem(idx,ev) {
    if(ev)ev.stopPropagation();
    if(ev&&ev.shiftKey&&lastSelectedIdx>=0){ const s=Math.min(lastSelectedIdx,idx),e=Math.max(lastSelectedIdx,idx); for(let i=s;i<=e;i++)selectedItems.add(i); }
    else if(ev&&(ev.ctrlKey||ev.metaKey)){ if(selectedItems.has(idx))selectedItems.delete(idx); else selectedItems.add(idx); }
    else { selectedItems.clear(); selectedItems.add(idx); }
    lastSelectedIdx=idx; updateSelectionUI();
}
function clearSelection(){ selectedItems.clear(); lastSelectedIdx=-1; updateSelectionUI(); }
function updateSelectionUI(){
    document.querySelectorAll('.file-item').forEach(el=>{ const i=parseInt(el.dataset.index),s=selectedItems.has(i); el.classList.toggle('selected',s); const cb=el.querySelector('.check-box'); if(cb)cb.textContent=s?'âœ“':''; });
    const bar=document.getElementById('selectionBar');
    if(selectedItems.size>1){ bar.classList.remove('hidden'); document.getElementById('selectionCount').textContent=selectedItems.size+'ê°œ ì„ íƒ'; }
    else bar.classList.add('hidden');
}
function getFirstSelected(){ if(!selectedItems.size)return null; return fileItems[[...selectedItems][0]]; }
function getItemPath(item){
    if(isSearchMode&&item.fullPath){ const h='/data/data/com.termux/files/home'; if(item.fullPath.startsWith('/storage'))return item.fullPath; return item.fullPath.replace(h+'/','').replace(h,''); }
    return currentPath?currentPath+'/'+item.name:item.name;
}

function openItem(idx) {
    const item=fileItems[idx];
    if(item.isDirectory){ if(isSearchMode&&item.fullPath)loadDir(item.fullPath); else loadDir(currentPath?currentPath+'/'+item.name:item.name); return; }
    const ext=item.name.split('.').pop().toLowerCase();
    const textExts=['txt','json','yaml','yml','js','ts','py','html','css','md','sh','log','cfg','conf','jsx','vue','xml','csv','toml','ini','env','mjs','cjs'];
    const imgExts=['png','jpg','jpeg','gif','webp','svg','bmp','ico'];
    selectedItems.clear(); selectedItems.add(idx);
    if(textExts.includes(ext)) editSelected();
    else if(imgExts.includes(ext)) previewImage();
    else downloadSelected();
}
function goUp(){ if(!currentPath||currentPath==='~')return; if(currentPath.startsWith('/storage')){const p=currentPath.split('/');p.pop();const par=p.join('/');loadDir(par.startsWith('/storage')?par:'');return;} const p=currentPath.split('/');p.pop();loadDir(p.join('/')); }
function goHome(){loadDir('')}
function goStorage(){loadDir('/storage/emulated/0')}
async function goSDCard(){
    try{ const res=await api('/list',{path:'/storage'}); const data=await res.json();
    const sd=data.items.filter(i=>i.isDirectory&&i.name!=='emulated'&&i.name!=='self'&&!i.name.startsWith('.'));
    if(sd.length===1)loadDir('/storage/'+sd[0].name); else if(sd.length>1){let h='<h3>ğŸ“€ SDì¹´ë“œ</h3>'; for(const s of sd)h+=`<button class="btn" style="width:100%;margin-bottom:8px" onclick="loadDir('/storage/${s.name}');closeModal()">ğŸ“€ ${s.name}</button>`; h+='<div class="modal-actions"><button class="btn" onclick="closeModal()">ì·¨ì†Œ</button></div>'; showModal(h);} else{loadDir('/storage');toast('SDì¹´ë“œ ì—†ìŒ','error');}
    }catch(e){toast('ì €ì¥ì†Œ ì ‘ê·¼ ì‹¤íŒ¨','error');}
}

// ===== SEARCH =====
function onSearchInput(v){ clearTimeout(searchTimeout); const q=v.trim(); if(!q){isSearchMode=false;document.getElementById('searchResultsBar').classList.add('hidden');applyFilterAndSort();return;} searchTimeout=setTimeout(()=>doSearch(q),300); }
async function doSearch(q){ try{ const res=await api('/search',{path:currentPath,query:q}); const data=await res.json(); isSearchMode=true; fileItems=data.results; document.getElementById('searchResultsBar').classList.remove('hidden'); document.getElementById('searchResultsBar').textContent=`ğŸ” "${q}" â†’ ${data.results.length}ê°œ`; renderFiles(fileItems); }catch(e){toast('ê²€ìƒ‰ ì‹¤íŒ¨','error');} }

// ===== CONTEXT MENU =====
function showContext(ev,idx){ ev.preventDefault(); ev.stopPropagation(); if(!selectedItems.has(idx)){selectedItems.clear();selectedItems.add(idx);lastSelectedIdx=idx;updateSelectionUI();} const m=document.getElementById('contextMenu'); m.style.left=Math.min(ev.clientX,innerWidth-190)+'px'; m.style.top=Math.min(ev.clientY,innerHeight-250)+'px'; document.getElementById('ctxDownloadZip').style.display=fileItems[idx]?.isDirectory?'':'none'; m.classList.add('active'); }
document.addEventListener('click',()=>document.getElementById('contextMenu').classList.remove('active'));

// ===== ACTIONS =====
async function downloadSelected(){ const item=getFirstSelected(); if(!item)return toast('ì„ íƒ ì—†ìŒ','error'); if(item.isDirectory)return downloadFolderZip(); try{ const res=await fetch(API_BASE+'/download',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({path:getItemPath(item)})}); const blob=await res.blob(); const u=URL.createObjectURL(blob); const a=document.createElement('a');a.href=u;a.download=item.name;a.click();URL.revokeObjectURL(u); toast('ë‹¤ìš´ë¡œë“œ: '+item.name); }catch(e){toast('ì‹¤íŒ¨: '+e.message,'error');} }
async function downloadFolderZip(){ const item=getFirstSelected(); if(!item?.isDirectory)return; toast('ğŸ“¦ ì••ì¶• ì¤‘...'); try{ const res=await fetch(API_BASE+'/download-zip',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({path:getItemPath(item)})}); if(!res.ok)throw new Error((await res.json().catch(()=>({}))).error||'fail'); const blob=await res.blob(); const u=URL.createObjectURL(blob); const a=document.createElement('a');a.href=u;a.download=item.name+'.tar.gz';a.click();URL.revokeObjectURL(u); toast('ğŸ“¦ ì™„ë£Œ: '+item.name+'.tar.gz'); }catch(e){toast('ì‹¤íŒ¨: '+e.message,'error');} }

async function previewSelected(){ const item=getFirstSelected(); if(!item)return; const ext=item.name.split('.').pop().toLowerCase(); if(['png','jpg','jpeg','gif','webp','svg','bmp','ico'].includes(ext))return previewImage(); try{ const res=await api('/read',{path:getItemPath(item)}); const data=await res.json(); showModal(`<h3>ğŸ“„ ${escHtml(item.name)} <span style="font-size:12px;color:var(--text-dim)">(${formatSize(data.size)})</span></h3><div class="preview-content">${escHtml(data.content)}</div><div class="modal-actions"><button class="btn" onclick="closeModal();editSelected()">âœï¸ í¸ì§‘</button><button class="btn" onclick="closeModal()">ë‹«ê¸°</button></div>`); }catch(e){toast('ë¯¸ë¦¬ë³´ê¸° ì‹¤íŒ¨','error');} }

function previewImage(){ const item=getFirstSelected(); if(!item)return; const url=API_BASE+'/preview-image?path='+encodeURIComponent(getItemPath(item)); showModal(`<h3>ğŸ–¼ ${escHtml(item.name)}</h3><div class="image-preview-container"><img src="${url}" onerror="this.parentElement.innerHTML='<span style=color:var(--red)>ë¡œë“œ ì‹¤íŒ¨</span>'"></div><div class="modal-actions"><button class="btn" onclick="closeModal();downloadSelected()">ğŸ“¥ ë‹¤ìš´ë¡œë“œ</button><button class="btn" onclick="closeModal()">ë‹«ê¸°</button></div>`); }

async function editSelected(){ const item=getFirstSelected(); if(!item||item.isDirectory)return toast('í¸ì§‘ ë¶ˆê°€','error'); const fp=getItemPath(item); try{ const res=await api('/read',{path:fp}); const data=await res.json(); showModal(`<h3>âœï¸ ${escHtml(item.name)}</h3><div class="editor-info">${escHtml(fp)} Â· ${formatSize(data.size)}</div><textarea class="editor-textarea" id="editorContent">${escHtml(data.content)}</textarea><div class="modal-actions"><button class="btn" onclick="closeModal()">ì·¨ì†Œ</button><button class="btn primary" onclick="saveEditor('${escHtml(fp).replace(/'/g,"\\'")}')">ğŸ’¾ ì €ì¥</button></div>`); const ta=document.getElementById('editorContent'); ta.addEventListener('keydown',e=>{if(e.key==='Tab'){e.preventDefault();const s=ta.selectionStart;ta.value=ta.value.substring(0,s)+'    '+ta.value.substring(ta.selectionEnd);ta.selectionStart=ta.selectionEnd=s+4;}if(e.key==='s'&&(e.ctrlKey||e.metaKey)){e.preventDefault();saveEditor(fp);}}); setTimeout(()=>ta.focus(),100); }catch(e){toast('ì—´ê¸° ì‹¤íŒ¨: '+e.message,'error');} }
async function saveEditor(fp){ const c=document.getElementById('editorContent').value; try{const res=await api('/write',{path:fp,content:c});const d=await res.json();toast('ì €ì¥ ì™„ë£Œ ('+formatSize(d.size)+')');closeModal();if(!isSearchMode)loadDir(currentPath);}catch(e){toast('ì €ì¥ ì‹¤íŒ¨: '+e.message,'error');} }

async function showFileInfo(){ const item=getFirstSelected(); if(!item)return; try{ const res=await api('/info',{path:getItemPath(item)}); const info=await res.json(); showModal(`<h3>â„¹ï¸ ìƒì„¸ ì •ë³´</h3><div style="font-family:'JetBrains Mono',monospace;font-size:12px;line-height:2"><div><b>ì´ë¦„:</b> ${escHtml(info.name)}</div><div><b>ê²½ë¡œ:</b> ${escHtml(info.path)}</div><div><b>íƒ€ì…:</b> ${info.isDirectory?'ğŸ“ ë””ë ‰í† ë¦¬':'ğŸ“„ íŒŒì¼'}${info.isSymlink?' â†’ '+escHtml(info.linkTarget):''}</div><div><b>í¬ê¸°:</b> ${formatSize(info.size)} (${(info.size||0).toLocaleString()} bytes)</div><div><b>ê¶Œí•œ:</b> ${info.mode} (uid:${info.uid} gid:${info.gid})</div><div><b>ìˆ˜ì •:</b> ${new Date(info.mtime).toLocaleString('ko-KR')}</div><div><b>ìƒì„±:</b> ${new Date(info.ctime).toLocaleString('ko-KR')}</div>${info.childCount!=null?`<div><b>í•˜ìœ„:</b> ${info.childCount}ê°œ</div>`:''}</div><div class="modal-actions"><button class="btn" onclick="closeModal()">ë‹«ê¸°</button></div>`); }catch(e){toast('ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨','error');} }

async function deleteSelected(){ const item=getFirstSelected(); if(!item||!confirm(`"${item.name}" ì‚­ì œ?`))return; try{await api('/delete',{path:getItemPath(item)});toast('ì‚­ì œ: '+item.name);loadDir(currentPath);}catch(e){toast('ì‚­ì œ ì‹¤íŒ¨','error');} }
async function batchDelete(){ if(selectedItems.size<2)return; const paths=[...selectedItems].map(i=>getItemPath(fileItems[i])); if(!confirm(`${selectedItems.size}ê°œ ì‚­ì œ?\n${paths.slice(0,5).join('\n')}${paths.length>5?'\n...ì™¸ '+(paths.length-5)+'ê°œ':''}`))return; try{const res=await api('/batch-delete',{paths});const d=await res.json();toast(`${d.deleted.length}ê°œ ì‚­ì œ`+(d.errors.length?`, ${d.errors.length}ê°œ ì‹¤íŒ¨`:''));clearSelection();loadDir(currentPath);}catch(e){toast('ì‹¤íŒ¨','error');} }

function renameSelected(){ const item=getFirstSelected(); if(!item)return; showModal(`<h3>âœï¸ ì´ë¦„ ë³€ê²½</h3><input type="text" id="renameInput" value="${escHtml(item.name)}" /><div class="modal-actions"><button class="btn" onclick="closeModal()">ì·¨ì†Œ</button><button class="btn primary" onclick="doRename('${escHtml(item.name).replace(/'/g,"\\'")}')">ë³€ê²½</button></div>`); setTimeout(()=>{const i=document.getElementById('renameInput');i?.focus();i?.select();},100); }
async function doRename(old){ const n=document.getElementById('renameInput').value.trim(); if(!n||n===old)return closeModal(); try{await api('/move',{from:currentPath?currentPath+'/'+old:old,to:currentPath?currentPath+'/'+n:n});toast('ë³€ê²½ ì™„ë£Œ');closeModal();loadDir(currentPath);}catch(e){toast('ì‹¤íŒ¨: '+e.message,'error');} }

// ===== UPLOAD =====
function showUploadModal(){ showModal(`<h3>ğŸ“¤ ì—…ë¡œë“œ</h3><div class="upload-zone" id="uploadZone" ondragover="event.preventDefault();this.classList.add('dragover')" ondragleave="this.classList.remove('dragover')" ondrop="handleDrop(event)"><div class="big-icon">ğŸ“¤</div><p>ë“œë˜ê·¸ ë˜ëŠ” ì•„ë˜ ë²„íŠ¼</p></div><div style="display:flex;gap:8px;margin-bottom:12px"><button class="btn" style="flex:1" onclick="document.getElementById('fileInput').click()">ğŸ“„ íŒŒì¼</button><button class="btn" style="flex:1" onclick="document.getElementById('folderInput').click()">ğŸ“ í´ë”</button></div><input type="file" id="fileInput" multiple style="display:none" onchange="handleFileInput(this.files)"><input type="file" id="folderInput" webkitdirectory style="display:none" onchange="handleFolderInput(this.files)"><div id="uploadList"></div><div class="modal-actions"><button class="btn" onclick="closeModal()">ì·¨ì†Œ</button><button class="btn primary" id="uploadBtn" onclick="doUpload()" style="display:none">ì—…ë¡œë“œ</button></div>`); }
let pendingUploads=[], failedUploads=[], lastUploadTargetPath='';
function handleDrop(ev){ ev.preventDefault(); ev.currentTarget.classList.remove('dragover'); const items=ev.dataTransfer.items; if(items&&items.length>0&&items[0].webkitGetAsEntry){ const entries=[]; for(let i=0;i<items.length;i++){const e=items[i].webkitGetAsEntry();if(e)entries.push(e);} pendingUploads=[]; let processing=0; function readEntry(entry,prefix){if(entry.isFile){processing++;entry.file(f=>{pendingUploads.push({file:f,relativePath:prefix+f.name});processing--;if(!processing)renderUploadList();});}else if(entry.isDirectory){processing++;const reader=entry.createReader();function readAll(){reader.readEntries(children=>{if(children.length>0){for(const c of children)readEntry(c,prefix+entry.name+'/');readAll();}else{processing--;if(!processing)renderUploadList();}});}readAll();}} for(const e of entries)readEntry(e,''); setTimeout(()=>{if(pendingUploads.length>0)renderUploadList();},200); }else handleFileInput(ev.dataTransfer.files); }
function handleFileInput(f){pendingUploads=Array.from(f).map(f=>({file:f,relativePath:f.name}));renderUploadList();}
function handleFolderInput(f){pendingUploads=Array.from(f).map(f=>({file:f,relativePath:f.webkitRelativePath||f.name}));renderUploadList();}
function renderUploadList(){ const list=document.getElementById('uploadList'); if(!list)return; const folders=new Set(); let fc=0; for(const u of pendingUploads){const p=u.relativePath.split('/');p.length>1?folders.add(p[0]+'/'):fc++;} let h=''; for(const f of folders)h+=`<div>ğŸ“ ${escHtml(f)} (${pendingUploads.filter(u=>u.relativePath.startsWith(f)).length}ê°œ)</div>`; if(fc>0){const singles=pendingUploads.filter(u=>!u.relativePath.includes('/')); for(const s of singles.slice(0,10))h+=`<div>ğŸ“„ ${escHtml(s.file.name)} (${formatSize(s.file.size)})</div>`; if(singles.length>10)h+=`<div>...ì™¸ ${singles.length-10}ê°œ</div>`;} h+=`<div style="margin-top:6px;color:var(--accent);font-size:12px">ì´ ${pendingUploads.length}ê°œ</div>`; list.innerHTML=h; document.getElementById('uploadBtn').style.display=pendingUploads.length?'inline-flex':'none'; }

async function doUpload(){ if(!pendingUploads.length)return; closeModal(); lastUploadTargetPath=currentPath; const total=pendingUploads.length; let uploaded=0,failed=0; failedUploads=[]; const startTime=Date.now(); let totalBytes=pendingUploads.reduce((s,u)=>s+u.file.size,0),sentBytes=0; const overlay=document.createElement('div'); overlay.className='progress-overlay'; overlay.id='uploadOverlay'; overlay.innerHTML=`<div class="progress-box"><h3>ğŸ“¤ ì—…ë¡œë“œ ì¤‘...</h3><div class="progress-bar-track"><div class="progress-bar-fill" id="progFill"></div></div><div id="progStats">0 / ${total}</div><div id="progSpeed" style="font-size:12px;color:var(--text-dim)"></div><div id="progActions" style="margin-top:16px;display:none"></div></div>`; document.body.appendChild(overlay);
function updateProg(){ const pct=Math.round(uploaded/total*100); document.getElementById('progFill').style.width=pct+'%'; document.getElementById('progStats').textContent=`${uploaded}/${total} (${pct}%)`; }
const CHUNK=10; for(let i=0;i<total;i+=CHUNK){ const chunk=pendingUploads.slice(i,i+CHUNK); const form=new FormData(); form.append('targetPath',currentPath); form.append('relativePaths',JSON.stringify(chunk.map(u=>u.relativePath))); for(const u of chunk)form.append('files',u.file); try{const res=await fetch(API_BASE+'/upload',{method:'POST',body:form}); const data=await res.json(); if(data.error)throw new Error(data.error); uploaded+=(data.uploaded||[]).length; sentBytes+=chunk.reduce((s,u)=>s+u.file.size,0); if(data.errors?.length){failed+=data.errors.length;uploaded+=data.errors.length;}}catch(e){failed+=chunk.length;uploaded+=chunk.length;failedUploads.push(...chunk);} updateProg();}
document.getElementById('progFill').style.width='100%'; if(failed>0){document.getElementById('progStats').textContent=`${total-failed}ì„±ê³µ/${failed}ì‹¤íŒ¨`; document.getElementById('progActions').style.display='block'; document.getElementById('progActions').innerHTML=`<button class="btn primary" onclick="retryFailed()">ğŸ”„ ì¬ì‹œë„</button> <button class="btn" onclick="closeUploadOverlay()">ë‹«ê¸°</button>`;} else{document.getElementById('progStats').textContent=`âœ… ${total}ê°œ ì™„ë£Œ!`; setTimeout(()=>{closeUploadOverlay();toast(`${total}ê°œ ì—…ë¡œë“œ ì™„ë£Œ`);},1000);} pendingUploads=[]; loadDir(currentPath); }
function closeUploadOverlay(){document.getElementById('uploadOverlay')?.remove();}
async function retryFailed(){pendingUploads=[...failedUploads];currentPath=lastUploadTargetPath;closeUploadOverlay();await doUpload();}

// ===== MKDIR =====
function showMkdirModal(){ showModal(`<h3>ğŸ“ ìƒˆ í´ë”</h3><input type="text" id="mkdirInput" placeholder="í´ë” ì´ë¦„"><div class="modal-actions"><button class="btn" onclick="closeModal()">ì·¨ì†Œ</button><button class="btn primary" onclick="doMkdir()">ë§Œë“¤ê¸°</button></div>`); setTimeout(()=>document.getElementById('mkdirInput')?.focus(),100); }
async function doMkdir(){ const n=document.getElementById('mkdirInput').value.trim(); if(!n)return; try{await api('/mkdir',{path:currentPath?currentPath+'/'+n:n});toast('ìƒì„±: '+n);closeModal();loadDir(currentPath);}catch(e){toast('ì‹¤íŒ¨','error');} }

// ===== BACKUP =====
async function backupST(){ toast('ë°±ì—… ì¤‘...'); try{const r=await api('/backup');const d=await r.json();toast(`ë°±ì—… ì™„ë£Œ! ${d.backupName}`);loadDir(currentPath);}catch(e){toast('ë°±ì—… ì‹¤íŒ¨','error');} }
function showRestoreModal(){ showModal(`<h3>ğŸ”„ ë³µì›</h3><input type="text" id="restoreInput" placeholder="ë°±ì—…íŒŒì¼ ê²½ë¡œ"><div class="modal-actions"><button class="btn" onclick="closeModal()">ì·¨ì†Œ</button><button class="btn primary" onclick="doRestore()">ë³µì›</button></div>`); }
async function doRestore(){ const p=document.getElementById('restoreInput').value.trim(); if(!p||!confirm('ë³µì›?'))return; try{await api('/restore',{path:p});toast('ë³µì› ì™„ë£Œ!');closeModal();}catch(e){toast('ì‹¤íŒ¨','error');} }

// ===== COPY/PASTE =====
let clipboardItem=null, clipboardPath='';
function copySelected(){ const item=getFirstSelected(); if(!item)return; clipboardItem=item; clipboardPath=getItemPath(item); toast(`ğŸ“‹ ë³µì‚¬: ${item.name}`); }
async function pasteHere(){ if(!clipboardItem)return toast('ë³µì‚¬ëœ íŒŒì¼ ì—†ìŒ','error'); try{await api('/copy',{from:clipboardPath,to:currentPath?currentPath+'/'+clipboardItem.name:clipboardItem.name});toast(`ë¶™ì—¬ë„£ê¸°: ${clipboardItem.name}`);loadDir(currentPath);}catch(e){toast('ì‹¤íŒ¨','error');} }

// ===== FAVORITES =====
function getFavorites(){try{return JSON.parse(localStorage.getItem('tfm-favorites')||'[]');}catch{return[];}}
function saveFavorites(f){localStorage.setItem('tfm-favorites',JSON.stringify(f));}
function addFavorite(){ const favs=getFavorites(); const name=currentPath?currentPath.split('/').pop():'í™ˆ'; if(favs.some(f=>f.path===currentPath))return toast('ì´ë¯¸ ìˆìŒ'); favs.push({name,path:currentPath}); saveFavorites(favs); renderFavorites(); toast(`â­ ì¶”ê°€: ${name}`); }
function removeFavorite(idx){ const f=getFavorites(); f.splice(idx,1); saveFavorites(f); renderFavorites(); }
function renderFavorites(){ const bar=document.getElementById('favBar'); const favs=getFavorites(); if(!favs.length){bar.classList.add('hidden');return;} bar.classList.remove('hidden'); bar.innerHTML=favs.map((f,i)=>`<div class="fav-chip" onclick="loadDir('${escHtml(f.path)}')">â­ ${escHtml(f.name)} <span class="fav-remove" onclick="event.stopPropagation();removeFavorite(${i})">âœ•</span></div>`).join(''); }

// ===== SETTINGS =====
function showSettingsModal(){ showModal(`<h3>âš™ï¸ ì„¤ì •</h3><p style="font-size:12px;color:var(--accent);margin-bottom:8px;font-weight:600">ğŸ“¦ ì—…ë°ì´íŠ¸</p><div style="display:flex;flex-direction:column;gap:6px;margin-bottom:16px"><button class="btn primary" onclick="doUpdate('fm')" style="width:100%">ğŸ“‚ íŒŒì¼ë§¤ë‹ˆì €</button><button class="btn" onclick="doUpdate('st')" style="width:100%">ğŸ­ SillyTavern</button><button class="btn" onclick="doUpdate('library')" style="width:100%">ğŸ“š ë„ì„œê´€</button></div><p style="font-size:12px;color:var(--accent);margin-bottom:8px;font-weight:600">ğŸ”§ ì„œë²„</p><div style="display:flex;flex-direction:column;gap:6px;margin-bottom:16px"><button class="btn" onclick="doUpdate('st-start')" style="width:100%">ğŸš€ ST ì‹œì‘</button><button class="btn" onclick="doUpdate('st-stop')" style="width:100%">â¹ ST ì¢…ë£Œ</button><button class="btn" onclick="doUpdate('library-start')" style="width:100%">ğŸš€ ë„ì„œê´€ ì‹œì‘</button><button class="btn" onclick="doUpdate('library-stop')" style="width:100%">â¹ ë„ì„œê´€ ì¢…ë£Œ</button><button class="btn danger" onclick="doRestart()" style="width:100%">ğŸ” FM ì¬ì‹œì‘</button></div><p style="font-size:12px;color:var(--accent);margin-bottom:8px;font-weight:600">ğŸ’¾ ë°±ì—…</p><div style="display:flex;flex-direction:column;gap:6px;margin-bottom:16px"><button class="btn primary" onclick="closeModal();backupST()" style="width:100%">ğŸ’¾ ST ë°±ì—…</button><button class="btn" onclick="closeModal();showRestoreModal()" style="width:100%">ğŸ”„ ë³µì›</button></div><p style="font-size:12px;color:var(--accent);margin-bottom:8px;font-weight:600">ğŸ”— ë„ì„œê´€ URL</p><input type="text" id="libraryUrlInput" value="${getLibraryUrl()}"><button class="btn" onclick="saveLibraryUrl()" style="width:100%;margin-bottom:12px">ì €ì¥</button><div id="updateLog" class="preview-content" style="margin-top:8px;display:none"></div><div class="modal-actions"><button class="btn" onclick="closeModal()">ë‹«ê¸°</button></div>`); }
function saveLibraryUrl(){const u=document.getElementById('libraryUrlInput').value.trim();if(u){localStorage.setItem('tfm-library-url',u);toast('URL ì €ì¥');}}
function getLibraryUrl(){return localStorage.getItem('tfm-library-url')||'http://localhost:7860';}
async function doUpdate(t){ const l=document.getElementById('updateLog'); l.style.display='block'; l.textContent='â³ ì§„í–‰ ì¤‘...\n'; try{const r=await api('/update',{target:t});const d=await r.json();l.textContent+=d.log||'';if(d.success){l.textContent+='\nâœ… ì™„ë£Œ!';if(t==='fm'){l.textContent+='\nğŸ”„ 3ì´ˆ í›„ ìƒˆë¡œê³ ì¹¨';setTimeout(()=>location.reload(),3000);}}}catch(e){l.textContent+='\nâŒ '+e.message;} }
async function doRestart(){ const l=document.getElementById('updateLog'); l.style.display='block'; l.textContent='ğŸ”„ ì¬ì‹œì‘ ì¤‘...'; try{await api('/restart');}catch(e){} setTimeout(()=>location.reload(),3000); }

// ===== MODAL =====
function showModal(h){document.getElementById('modalContent').innerHTML=h;document.getElementById('modalOverlay').classList.add('active');}
function closeModal(){document.getElementById('modalOverlay').classList.remove('active');}
function closeModalOutside(ev){if(ev.target===document.getElementById('modalOverlay'))closeModal();}

// ===== KEYBOARD =====
document.addEventListener('keydown',ev=>{
    const inModal=document.querySelector('.modal-overlay.active');
    if(ev.key==='Escape'){if(inModal)closeModal();else if(isSearchMode){document.getElementById('searchInput').value='';onSearchInput('');}}
    if(!inModal&&ev.key==='Backspace'&&!['INPUT','TEXTAREA'].includes(document.activeElement.tagName)){ev.preventDefault();goUp();}
    if(!inModal&&ev.key==='Delete'&&selectedItems.size>0){ev.preventDefault();if(selectedItems.size>1)batchDelete();else deleteSelected();}
    if(!inModal&&ev.key==='a'&&(ev.ctrlKey||ev.metaKey)&&!termState.visible){ev.preventDefault();for(let i=0;i<fileItems.length;i++)selectedItems.add(i);updateSelectionUI();}
    if(!inModal&&ev.key==='f'&&(ev.ctrlKey||ev.metaKey)&&!termState.visible){ev.preventDefault();document.getElementById('searchInput').focus();}
});
document.getElementById('fileArea').addEventListener('click',ev=>{if(!ev.target.closest('.file-item'))clearSelection();});

// ===== TERMINAL =====
const termState={sessions:{},activeId:null,cmdHistory:[],histIdx:-1,visible:false};
function toggleTerminal(){ termState.visible=!termState.visible; const tv=document.getElementById('terminalView'),fa=document.getElementById('fileArea'),tb=document.getElementById('mainToolbar'),st=document.getElementById('subToolbar'),sb=document.getElementById('selectionBar'),fb=document.getElementById('favBar'),sr=document.getElementById('searchResultsBar'),btn=document.getElementById('termToggleBtn');
if(termState.visible){tv.classList.add('active');fa.classList.add('file-area-hidden');tb.classList.add('toolbar-hidden');st.classList.add('hidden');sb.classList.add('hidden');fb.classList.add('hidden');sr.classList.add('hidden');btn.classList.add('primary');btn.textContent='ğŸ“‚ íŒŒì¼'; if(!termState.activeId||!termState.sessions[termState.activeId]?.alive)termNewTab(); document.getElementById('termInput').focus();}
else{tv.classList.remove('active');fa.classList.remove('file-area-hidden');tb.classList.remove('toolbar-hidden');st.classList.remove('hidden');renderFavorites();btn.classList.remove('primary');btn.textContent='ğŸ–¥ í„°ë¯¸ë„';} }

async function termNewTab(cwd){ try{ document.getElementById('termOutput').textContent='ì—°ê²° ì¤‘...'; const res=await fetch(API_BASE+'/terminal/spawn',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({cwd:cwd||''})}); const d=await res.json(); if(d.error)return toast('ì‹¤íŒ¨: '+d.error,'error'); const s={id:d.id,alive:true,buffer:'',eventSource:null,cwd:cwd||'/data/data/com.termux/files/home'}; termState.sessions[d.id]=s; termState.activeId=d.id; termConnectSSE(d.id); termRenderTabs(); termUpdateStatus();
try{const er=await fetch(API_BASE+'/terminal/exec',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({command:'echo "=== í„°ë¯¸ë„ #'+d.id+' ===" && echo "$(whoami)@$(hostname):$(pwd)" && echo "---"',sessionId:d.id})}); const ed=await er.json(); s.buffer=(ed.output||'')+'\n'; if(ed.cwd)s.cwd=ed.cwd;}catch(e){s.buffer='ì—°ê²°ë¨\n';}
termRenderOutput(); document.getElementById('termInput')?.focus(); }catch(e){toast('ì—°ê²° ì‹¤íŒ¨','error');} }

function termConnectSSE(id){ const s=termState.sessions[id]; if(!s)return; if(s.eventSource)try{s.eventSource.close();}catch(e){} const es=new EventSource(API_BASE+'/terminal/stream?id='+id); s.eventSource=es;
es.onmessage=e=>{try{const m=JSON.parse(e.data); if(m.type==='history')s.buffer=m.data; else if(m.type==='output')s.buffer+=m.data; else if(m.type==='exit'||m.type==='error'){s.buffer+=m.data||'';s.alive=false;termUpdateStatus();termRenderTabs();} if(termState.activeId===id)termRenderOutput();}catch(er){}};
es.onerror=()=>{if(s.alive&&!s._rec){s._rec=true;setTimeout(()=>{s._rec=false;if(s.alive)termConnectSSE(id);},2000);}}; }

function termRenderOutput(){ const s=termState.sessions[termState.activeId]; if(!s)return; const el=document.getElementById('termOutput'); let t=s.buffer; t=t.replace(/\x1b\[[0-9;?]*[a-zA-Z]/g,'').replace(/\x1b\][^\x07\x1b]*(?:\x07|\x1b\\)/g,'').replace(/\x1b[()][A-Z0-9]/g,'').replace(/\x1b[>=<]/g,'').replace(/\r(?!\n)/g,'').replace(/\x07/g,''); if(t.length>200000)t=t.slice(-150000); el.textContent=t; requestAnimationFrame(()=>{el.scrollTop=el.scrollHeight;}); }
function termRenderTabs(){ document.getElementById('termTabs').innerHTML=Object.values(termState.sessions).map(s=>`<span class="term-tab ${s.id===termState.activeId?'active':''}" onclick="termSwitchTab('${s.id}')">${s.alive?'ğŸŸ¢':'âš«'} #${s.id}<span class="tab-close" onclick="event.stopPropagation();termCloseTab('${s.id}')">Ã—</span></span>`).join(''); }
function termSwitchTab(id){termState.activeId=id;termRenderTabs();termRenderOutput();termUpdateStatus();document.getElementById('termInput')?.focus();}
async function termCloseTab(id){ const s=termState.sessions[id]; if(s){if(s.eventSource)try{s.eventSource.close();}catch(e){} if(s.alive)try{await fetch(API_BASE+'/terminal/kill',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id})});}catch(e){} delete termState.sessions[id];} const rem=Object.keys(termState.sessions); termState.activeId=rem.length?rem[rem.length-1]:null; if(!termState.activeId)document.getElementById('termOutput').textContent=''; termRenderTabs();termRenderOutput();termUpdateStatus(); }
function termUpdateStatus(){ const s=termState.sessions[termState.activeId]; const dot=document.getElementById('termDot'),txt=document.getElementById('termStatusText'); if(!s){dot.className='term-dot';txt.textContent='ì—°ê²° ì•ˆ ë¨';} else if(s.alive){dot.className='term-dot alive';txt.textContent=`#${s.id} | ${(s.cwd||'~').replace(/^\/data\/data\/com\.termux\/files\/home/,'~')}`;} else{dot.className='term-dot';txt.textContent=`#${s.id} ì¢…ë£Œë¨`;} }

async function termSendInput(){ const input=document.getElementById('termInput'),cmd=input.value; const s=termState.sessions[termState.activeId]; if(!s?.alive)return toast('í„°ë¯¸ë„ ì—†ìŒ','error'); if(cmd.trim()){termState.cmdHistory.push(cmd);if(termState.cmdHistory.length>200)termState.cmdHistory=termState.cmdHistory.slice(-100);} termState.histIdx=-1; input.value=''; const pr=(s.cwd||'~').replace(/^\/data\/data\/com\.termux\/files\/home/,'~'); s.buffer+=pr+'$ '+cmd+'\n'; termRenderOutput(); if(!cmd.trim())return;
try{const r=await fetch(API_BASE+'/terminal/exec',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({command:cmd,sessionId:s.id})}); const d=await r.json(); if(d.cwd)s.cwd=d.cwd; if(d.output){s.buffer+=d.output;if(!d.output.endsWith('\n'))s.buffer+='\n';} termRenderOutput();termUpdateStatus();}catch(e){s.buffer+='âŒ '+e.message+'\n';termRenderOutput();} }

async function termSignal(sig){if(!termState.activeId)return;try{await fetch(API_BASE+'/terminal/signal',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id:termState.activeId,signal:sig||'SIGINT'})});}catch(e){}}
async function termKillCurrent(){if(!termState.activeId||!confirm('ì¢…ë£Œ?'))return;await termCloseTab(termState.activeId);}
function termClearScreen(){const s=termState.sessions[termState.activeId];if(s)s.buffer='';document.getElementById('termOutput').textContent='';}
function termQuick(cmd){const s=termState.sessions[termState.activeId];if(!s?.alive)return toast('í„°ë¯¸ë„ ì—†ìŒ','error');document.getElementById('termInput').value=cmd;termSendInput();}

document.addEventListener('DOMContentLoaded',()=>{const ti=document.getElementById('termInput'); if(ti)ti.addEventListener('keydown',e=>{if(e.key==='Enter'){e.preventDefault();termSendInput();}else if(e.key==='ArrowUp'){e.preventDefault();if(termState.cmdHistory.length>0){if(termState.histIdx<0)termState.histIdx=termState.cmdHistory.length;termState.histIdx=Math.max(0,termState.histIdx-1);ti.value=termState.cmdHistory[termState.histIdx]||'';}}else if(e.key==='ArrowDown'){e.preventDefault();if(termState.histIdx>=0){termState.histIdx=Math.min(termState.cmdHistory.length,termState.histIdx+1);ti.value=termState.cmdHistory[termState.histIdx]||'';}}else if(e.key==='c'&&e.ctrlKey){e.preventDefault();termSignal('SIGINT');}});});

renderFavorites(); loadDir('');
</script>
</body>
</html>
